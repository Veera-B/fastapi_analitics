name: Deploy Backend on Tag

on:
  push:
    tags:
      - "v*"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Extract tag
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        echo "TAG=$TAG" >> $GITHUB_ENV

    - name: Build Docker image
      run: |
        docker build -t fastapi-analytics:${TAG} .

    - name: Trigger Railway redeploy
      run: |
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
          -H "Content-Type: application/json" \
          https://backboard.railway.app/graphql \
          --data '{"query":"mutation { redeployLatest(projectId: \"'${{ secrets.RAILWAY_PROJECT_ID }}'\") }"}'
